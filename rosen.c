#include "nibble.h"

#include <stdio.h>
#include <assert.h>

typedef unsigned /*long*/ long ul;

#if 1

#define R(X)                                                                   \
  X(15) X(14) X(13) X(12) X(11) X(10) X(9) X(8) X(7) X(6) X(5) X(4) X(3) X(2)  \
      X(1) X(0)

void nibble_sort_rosen(unsigned long *pv) {
  unsigned char c[16] = {};
  for (unsigned long *e = pv + 1024; pv != e; ++pv) {
    register unsigned long v = *pv;
#define S(_)                                                                   \
  {                                                                            \
    ++c[v & 15];                                                               \
    v >>= 4;                                                                   \
  }
    R(S)
#define V(n)                                                                   \
  while (c[n]) {                                                               \
    v = (v << 4) | n;                                                          \
    --c[n];                                                                    \
  }
    R(V);
    *pv = v;
  }
}

#elif 0

#define N(a, b) ((unsigned long)(b) << (4 * (a)))
#define M(a)                                                                   \
  N(a, 0), N(a, 1), N(a, 2), N(a, 3), N(a, 4), N(a, 5), N(a, 6), N(a, 7),      \
      N(a, 8), N(a, 9), N(a, 10), N(a, 11), N(a, 12), N(a, 13), N(a, 14),      \
      N(a, 15)
unsigned long t[16][16] = {M(0),  M(1),  M(2),  M(3), M(4),  M(5),
                           M(6),  M(7),  M(8),  M(9), M(10), M(11),
                           M(12), M(13), M(14), M(15)};
#define R(X)                                                                   \
  X(0) X(1) X(2) X(3) X(4) X(5) X(6) X(7) X(8) X(9) X(10) X(11) X(12) X(13)    \
      X(14) X(15)
void nibble_sort_rosen(unsigned long *pv) {
  unsigned char c[16] = {};
  for (unsigned long *e = pv + 1024; pv != e; ++pv) {
    register unsigned char i = 0;
    register unsigned long v = *pv;
#define S(n)                                                                   \
  ++c[(unsigned char)(v & 15)];                                                \
  v >>= 4;
    R(S)
#define V(n)                                                                   \
  while (c[n]) {                                                               \
    v |= t[i++][n];                                                            \
    --c[n];                                                                    \
  }
    R(V);
    *pv = v;
  }
}

#elif 0

#define N(a, b) ((ul)(b) << (4 * (a)))

static ul t[16][16] = {
    N(0, 0),   N(0, 1),   N(0, 2),   N(0, 3),   N(0, 4),   N(0, 5),   N(0, 6),
    N(0, 7),   N(0, 8),   N(0, 9),   N(0, 10),  N(0, 11),  N(0, 12),  N(0, 13),
    N(0, 14),  N(0, 15),  N(1, 0),   N(1, 1),   N(1, 2),   N(1, 3),   N(1, 4),
    N(1, 5),   N(1, 6),   N(1, 7),   N(1, 8),   N(1, 9),   N(1, 10),  N(1, 11),
    N(1, 12),  N(1, 13),  N(1, 14),  N(1, 15),  N(2, 0),   N(2, 1),   N(2, 2),
    N(2, 3),   N(2, 4),   N(2, 5),   N(2, 6),   N(2, 7),   N(2, 8),   N(2, 9),
    N(2, 10),  N(2, 11),  N(2, 12),  N(2, 13),  N(2, 14),  N(2, 15),  N(3, 0),
    N(3, 1),   N(3, 2),   N(3, 3),   N(3, 4),   N(3, 5),   N(3, 6),   N(3, 7),
    N(3, 8),   N(3, 9),   N(3, 10),  N(3, 11),  N(3, 12),  N(3, 13),  N(3, 14),
    N(3, 15),  N(4, 0),   N(4, 1),   N(4, 2),   N(4, 3),   N(4, 4),   N(4, 5),
    N(4, 6),   N(4, 7),   N(4, 8),   N(4, 9),   N(4, 10),  N(4, 11),  N(4, 12),
    N(4, 13),  N(4, 14),  N(4, 15),  N(5, 0),   N(5, 1),   N(5, 2),   N(5, 3),
    N(5, 4),   N(5, 5),   N(5, 6),   N(5, 7),   N(5, 8),   N(5, 9),   N(5, 10),
    N(5, 11),  N(5, 12),  N(5, 13),  N(5, 14),  N(5, 15),  N(6, 0),   N(6, 1),
    N(6, 2),   N(6, 3),   N(6, 4),   N(6, 5),   N(6, 6),   N(6, 7),   N(6, 8),
    N(6, 9),   N(6, 10),  N(6, 11),  N(6, 12),  N(6, 13),  N(6, 14),  N(6, 15),
    N(7, 0),   N(7, 1),   N(7, 2),   N(7, 3),   N(7, 4),   N(7, 5),   N(7, 6),
    N(7, 7),   N(7, 8),   N(7, 9),   N(7, 10),  N(7, 11),  N(7, 12),  N(7, 13),
    N(7, 14),  N(7, 15),  N(8, 0),   N(8, 1),   N(8, 2),   N(8, 3),   N(8, 4),
    N(8, 5),   N(8, 6),   N(8, 7),   N(8, 8),   N(8, 9),   N(8, 10),  N(8, 11),
    N(8, 12),  N(8, 13),  N(8, 14),  N(8, 15),  N(9, 0),   N(9, 1),   N(9, 2),
    N(9, 3),   N(9, 4),   N(9, 5),   N(9, 6),   N(9, 7),   N(9, 8),   N(9, 9),
    N(9, 10),  N(9, 11),  N(9, 12),  N(9, 13),  N(9, 14),  N(9, 15),  N(10, 0),
    N(10, 1),  N(10, 2),  N(10, 3),  N(10, 4),  N(10, 5),  N(10, 6),  N(10, 7),
    N(10, 8),  N(10, 9),  N(10, 10), N(10, 11), N(10, 12), N(10, 13), N(10, 14),
    N(10, 15), N(11, 0),  N(11, 1),  N(11, 2),  N(11, 3),  N(11, 4),  N(11, 5),
    N(11, 6),  N(11, 7),  N(11, 8),  N(11, 9),  N(11, 10), N(11, 11), N(11, 12),
    N(11, 13), N(11, 14), N(11, 15), N(12, 0),  N(12, 1),  N(12, 2),  N(12, 3),
    N(12, 4),  N(12, 5),  N(12, 6),  N(12, 7),  N(12, 8),  N(12, 9),  N(12, 10),
    N(12, 11), N(12, 12), N(12, 13), N(12, 14), N(12, 15), N(13, 0),  N(13, 1),
    N(13, 2),  N(13, 3),  N(13, 4),  N(13, 5),  N(13, 6),  N(13, 7),  N(13, 8),
    N(13, 9),  N(13, 10), N(13, 11), N(13, 12), N(13, 13), N(13, 14), N(13, 15),
    N(14, 0),  N(14, 1),  N(14, 2),  N(14, 3),  N(14, 4),  N(14, 5),  N(14, 6),
    N(14, 7),  N(14, 8),  N(14, 9),  N(14, 10), N(14, 11), N(14, 12), N(14, 13),
    N(14, 14), N(14, 15), N(15, 0),  N(15, 1),  N(15, 2),  N(15, 3),  N(15, 4),
    N(15, 5),  N(15, 6),  N(15, 7),  N(15, 8),  N(15, 9),  N(15, 10), N(15, 11),
    N(15, 12), N(15, 13), N(15, 14), N(15, 15),
};

void nibble_sort_rosen(ul *pv) {
  assert(sizeof(ul) == 8);
  typedef unsigned char uc;
  uc c[16] = {};
  for (ul *e = pv + 1024; pv != e; ++pv) {
    ul v = *pv;
    ++c[(uc)((v >> 60) & 15)];
    ++c[(uc)((v >> 56) & 15)];
    ++c[(uc)((v >> 52) & 15)];
    ++c[(uc)((v >> 48) & 15)];
    ++c[(uc)((v >> 44) & 15)];
    ++c[(uc)((v >> 40) & 15)];
    ++c[(uc)((v >> 36) & 15)];
    ++c[(uc)((v >> 32) & 15)];
    ++c[(uc)((v >> 28) & 15)];
    ++c[(uc)((v >> 24) & 15)];
    ++c[(uc)((v >> 20) & 15)];
    ++c[(uc)((v >> 16) & 15)];
    ++c[(uc)((v >> 12) & 15)];
    ++c[(uc)((v >> 8) & 15)];
    ++c[(uc)((v >> 4) & 15)];
    ++c[(uc)(v & 15)];
    v = 0;
    uc i = 0;
    while (c[0]) {
      i++;
      --c[0];
    }
    while (c[1]) {
      v |= t[i++][1];
      --c[1];
    }
    while (c[2]) {
      v |= t[i++][2];
      --c[2];
    }
    while (c[3]) {
      v |= t[i++][3];
      --c[3];
    }
    while (c[4]) {
      v |= t[i++][4];
      --c[4];
    }
    while (c[5]) {
      v |= t[i++][5];
      --c[5];
    }
    while (c[6]) {
      v |= t[i++][6];
      --c[6];
    }
    while (c[7]) {
      v |= t[i++][7];
      --c[7];
    }
    while (c[8]) {
      v |= t[i++][8];
      --c[8];
    }
    while (c[9]) {
      v |= t[i++][9];
      --c[9];
    }
    while (c[10]) {
      v |= t[i++][10];
      --c[10];
    }
    while (c[11]) {
      v |= t[i++][11];
      --c[11];
    }
    while (c[12]) {
      v |= t[i++][12];
      --c[12];
    }
    while (c[13]) {
      v |= t[i++][13];
      --c[13];
    }
    while (c[14]) {
      v |= t[i++][14];
      --c[14];
    }
    while (c[15]) {
      v |= t[i++][15];
      --c[15];
    }
    *pv = v;
  }
}

#endif
