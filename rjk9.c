#include "nibble.h"

static const unsigned long inc[256][2] = {
    {0x0000000000000000, 0x0200000000000000},
    {0x0000000000000000, 0x0101000000000000},
    {0x0000000000000000, 0x0100010000000000},
    {0x0000000000000000, 0x0100000100000000},
    {0x0000000000000000, 0x0100000001000000},
    {0x0000000000000000, 0x0100000000010000},
    {0x0000000000000000, 0x0100000000000100},
    {0x0000000000000000, 0x0100000000000001},
    {0x0100000000000000, 0x0100000000000000},
    {0x0001000000000000, 0x0100000000000000},
    {0x0000010000000000, 0x0100000000000000},
    {0x0000000100000000, 0x0100000000000000},
    {0x0000000001000000, 0x0100000000000000},
    {0x0000000000010000, 0x0100000000000000},
    {0x0000000000000100, 0x0100000000000000},
    {0x0000000000000001, 0x0100000000000000},
    {0x0000000000000000, 0x0101000000000000},
    {0x0000000000000000, 0x0002000000000000},
    {0x0000000000000000, 0x0001010000000000},
    {0x0000000000000000, 0x0001000100000000},
    {0x0000000000000000, 0x0001000001000000},
    {0x0000000000000000, 0x0001000000010000},
    {0x0000000000000000, 0x0001000000000100},
    {0x0000000000000000, 0x0001000000000001},
    {0x0100000000000000, 0x0001000000000000},
    {0x0001000000000000, 0x0001000000000000},
    {0x0000010000000000, 0x0001000000000000},
    {0x0000000100000000, 0x0001000000000000},
    {0x0000000001000000, 0x0001000000000000},
    {0x0000000000010000, 0x0001000000000000},
    {0x0000000000000100, 0x0001000000000000},
    {0x0000000000000001, 0x0001000000000000},
    {0x0000000000000000, 0x0100010000000000},
    {0x0000000000000000, 0x0001010000000000},
    {0x0000000000000000, 0x0000020000000000},
    {0x0000000000000000, 0x0000010100000000},
    {0x0000000000000000, 0x0000010001000000},
    {0x0000000000000000, 0x0000010000010000},
    {0x0000000000000000, 0x0000010000000100},
    {0x0000000000000000, 0x0000010000000001},
    {0x0100000000000000, 0x0000010000000000},
    {0x0001000000000000, 0x0000010000000000},
    {0x0000010000000000, 0x0000010000000000},
    {0x0000000100000000, 0x0000010000000000},
    {0x0000000001000000, 0x0000010000000000},
    {0x0000000000010000, 0x0000010000000000},
    {0x0000000000000100, 0x0000010000000000},
    {0x0000000000000001, 0x0000010000000000},
    {0x0000000000000000, 0x0100000100000000},
    {0x0000000000000000, 0x0001000100000000},
    {0x0000000000000000, 0x0000010100000000},
    {0x0000000000000000, 0x0000000200000000},
    {0x0000000000000000, 0x0000000101000000},
    {0x0000000000000000, 0x0000000100010000},
    {0x0000000000000000, 0x0000000100000100},
    {0x0000000000000000, 0x0000000100000001},
    {0x0100000000000000, 0x0000000100000000},
    {0x0001000000000000, 0x0000000100000000},
    {0x0000010000000000, 0x0000000100000000},
    {0x0000000100000000, 0x0000000100000000},
    {0x0000000001000000, 0x0000000100000000},
    {0x0000000000010000, 0x0000000100000000},
    {0x0000000000000100, 0x0000000100000000},
    {0x0000000000000001, 0x0000000100000000},
    {0x0000000000000000, 0x0100000001000000},
    {0x0000000000000000, 0x0001000001000000},
    {0x0000000000000000, 0x0000010001000000},
    {0x0000000000000000, 0x0000000101000000},
    {0x0000000000000000, 0x0000000002000000},
    {0x0000000000000000, 0x0000000001010000},
    {0x0000000000000000, 0x0000000001000100},
    {0x0000000000000000, 0x0000000001000001},
    {0x0100000000000000, 0x0000000001000000},
    {0x0001000000000000, 0x0000000001000000},
    {0x0000010000000000, 0x0000000001000000},
    {0x0000000100000000, 0x0000000001000000},
    {0x0000000001000000, 0x0000000001000000},
    {0x0000000000010000, 0x0000000001000000},
    {0x0000000000000100, 0x0000000001000000},
    {0x0000000000000001, 0x0000000001000000},
    {0x0000000000000000, 0x0100000000010000},
    {0x0000000000000000, 0x0001000000010000},
    {0x0000000000000000, 0x0000010000010000},
    {0x0000000000000000, 0x0000000100010000},
    {0x0000000000000000, 0x0000000001010000},
    {0x0000000000000000, 0x0000000000020000},
    {0x0000000000000000, 0x0000000000010100},
    {0x0000000000000000, 0x0000000000010001},
    {0x0100000000000000, 0x0000000000010000},
    {0x0001000000000000, 0x0000000000010000},
    {0x0000010000000000, 0x0000000000010000},
    {0x0000000100000000, 0x0000000000010000},
    {0x0000000001000000, 0x0000000000010000},
    {0x0000000000010000, 0x0000000000010000},
    {0x0000000000000100, 0x0000000000010000},
    {0x0000000000000001, 0x0000000000010000},
    {0x0000000000000000, 0x0100000000000100},
    {0x0000000000000000, 0x0001000000000100},
    {0x0000000000000000, 0x0000010000000100},
    {0x0000000000000000, 0x0000000100000100},
    {0x0000000000000000, 0x0000000001000100},
    {0x0000000000000000, 0x0000000000010100},
    {0x0000000000000000, 0x0000000000000200},
    {0x0000000000000000, 0x0000000000000101},
    {0x0100000000000000, 0x0000000000000100},
    {0x0001000000000000, 0x0000000000000100},
    {0x0000010000000000, 0x0000000000000100},
    {0x0000000100000000, 0x0000000000000100},
    {0x0000000001000000, 0x0000000000000100},
    {0x0000000000010000, 0x0000000000000100},
    {0x0000000000000100, 0x0000000000000100},
    {0x0000000000000001, 0x0000000000000100},
    {0x0000000000000000, 0x0100000000000001},
    {0x0000000000000000, 0x0001000000000001},
    {0x0000000000000000, 0x0000010000000001},
    {0x0000000000000000, 0x0000000100000001},
    {0x0000000000000000, 0x0000000001000001},
    {0x0000000000000000, 0x0000000000010001},
    {0x0000000000000000, 0x0000000000000101},
    {0x0000000000000000, 0x0000000000000002},
    {0x0100000000000000, 0x0000000000000001},
    {0x0001000000000000, 0x0000000000000001},
    {0x0000010000000000, 0x0000000000000001},
    {0x0000000100000000, 0x0000000000000001},
    {0x0000000001000000, 0x0000000000000001},
    {0x0000000000010000, 0x0000000000000001},
    {0x0000000000000100, 0x0000000000000001},
    {0x0000000000000001, 0x0000000000000001},
    {0x0100000000000000, 0x0100000000000000},
    {0x0100000000000000, 0x0001000000000000},
    {0x0100000000000000, 0x0000010000000000},
    {0x0100000000000000, 0x0000000100000000},
    {0x0100000000000000, 0x0000000001000000},
    {0x0100000000000000, 0x0000000000010000},
    {0x0100000000000000, 0x0000000000000100},
    {0x0100000000000000, 0x0000000000000001},
    {0x0200000000000000, 0x0000000000000000},
    {0x0101000000000000, 0x0000000000000000},
    {0x0100010000000000, 0x0000000000000000},
    {0x0100000100000000, 0x0000000000000000},
    {0x0100000001000000, 0x0000000000000000},
    {0x0100000000010000, 0x0000000000000000},
    {0x0100000000000100, 0x0000000000000000},
    {0x0100000000000001, 0x0000000000000000},
    {0x0001000000000000, 0x0100000000000000},
    {0x0001000000000000, 0x0001000000000000},
    {0x0001000000000000, 0x0000010000000000},
    {0x0001000000000000, 0x0000000100000000},
    {0x0001000000000000, 0x0000000001000000},
    {0x0001000000000000, 0x0000000000010000},
    {0x0001000000000000, 0x0000000000000100},
    {0x0001000000000000, 0x0000000000000001},
    {0x0101000000000000, 0x0000000000000000},
    {0x0002000000000000, 0x0000000000000000},
    {0x0001010000000000, 0x0000000000000000},
    {0x0001000100000000, 0x0000000000000000},
    {0x0001000001000000, 0x0000000000000000},
    {0x0001000000010000, 0x0000000000000000},
    {0x0001000000000100, 0x0000000000000000},
    {0x0001000000000001, 0x0000000000000000},
    {0x0000010000000000, 0x0100000000000000},
    {0x0000010000000000, 0x0001000000000000},
    {0x0000010000000000, 0x0000010000000000},
    {0x0000010000000000, 0x0000000100000000},
    {0x0000010000000000, 0x0000000001000000},
    {0x0000010000000000, 0x0000000000010000},
    {0x0000010000000000, 0x0000000000000100},
    {0x0000010000000000, 0x0000000000000001},
    {0x0100010000000000, 0x0000000000000000},
    {0x0001010000000000, 0x0000000000000000},
    {0x0000020000000000, 0x0000000000000000},
    {0x0000010100000000, 0x0000000000000000},
    {0x0000010001000000, 0x0000000000000000},
    {0x0000010000010000, 0x0000000000000000},
    {0x0000010000000100, 0x0000000000000000},
    {0x0000010000000001, 0x0000000000000000},
    {0x0000000100000000, 0x0100000000000000},
    {0x0000000100000000, 0x0001000000000000},
    {0x0000000100000000, 0x0000010000000000},
    {0x0000000100000000, 0x0000000100000000},
    {0x0000000100000000, 0x0000000001000000},
    {0x0000000100000000, 0x0000000000010000},
    {0x0000000100000000, 0x0000000000000100},
    {0x0000000100000000, 0x0000000000000001},
    {0x0100000100000000, 0x0000000000000000},
    {0x0001000100000000, 0x0000000000000000},
    {0x0000010100000000, 0x0000000000000000},
    {0x0000000200000000, 0x0000000000000000},
    {0x0000000101000000, 0x0000000000000000},
    {0x0000000100010000, 0x0000000000000000},
    {0x0000000100000100, 0x0000000000000000},
    {0x0000000100000001, 0x0000000000000000},
    {0x0000000001000000, 0x0100000000000000},
    {0x0000000001000000, 0x0001000000000000},
    {0x0000000001000000, 0x0000010000000000},
    {0x0000000001000000, 0x0000000100000000},
    {0x0000000001000000, 0x0000000001000000},
    {0x0000000001000000, 0x0000000000010000},
    {0x0000000001000000, 0x0000000000000100},
    {0x0000000001000000, 0x0000000000000001},
    {0x0100000001000000, 0x0000000000000000},
    {0x0001000001000000, 0x0000000000000000},
    {0x0000010001000000, 0x0000000000000000},
    {0x0000000101000000, 0x0000000000000000},
    {0x0000000002000000, 0x0000000000000000},
    {0x0000000001010000, 0x0000000000000000},
    {0x0000000001000100, 0x0000000000000000},
    {0x0000000001000001, 0x0000000000000000},
    {0x0000000000010000, 0x0100000000000000},
    {0x0000000000010000, 0x0001000000000000},
    {0x0000000000010000, 0x0000010000000000},
    {0x0000000000010000, 0x0000000100000000},
    {0x0000000000010000, 0x0000000001000000},
    {0x0000000000010000, 0x0000000000010000},
    {0x0000000000010000, 0x0000000000000100},
    {0x0000000000010000, 0x0000000000000001},
    {0x0100000000010000, 0x0000000000000000},
    {0x0001000000010000, 0x0000000000000000},
    {0x0000010000010000, 0x0000000000000000},
    {0x0000000100010000, 0x0000000000000000},
    {0x0000000001010000, 0x0000000000000000},
    {0x0000000000020000, 0x0000000000000000},
    {0x0000000000010100, 0x0000000000000000},
    {0x0000000000010001, 0x0000000000000000},
    {0x0000000000000100, 0x0100000000000000},
    {0x0000000000000100, 0x0001000000000000},
    {0x0000000000000100, 0x0000010000000000},
    {0x0000000000000100, 0x0000000100000000},
    {0x0000000000000100, 0x0000000001000000},
    {0x0000000000000100, 0x0000000000010000},
    {0x0000000000000100, 0x0000000000000100},
    {0x0000000000000100, 0x0000000000000001},
    {0x0100000000000100, 0x0000000000000000},
    {0x0001000000000100, 0x0000000000000000},
    {0x0000010000000100, 0x0000000000000000},
    {0x0000000100000100, 0x0000000000000000},
    {0x0000000001000100, 0x0000000000000000},
    {0x0000000000010100, 0x0000000000000000},
    {0x0000000000000200, 0x0000000000000000},
    {0x0000000000000101, 0x0000000000000000},
    {0x0000000000000001, 0x0100000000000000},
    {0x0000000000000001, 0x0001000000000000},
    {0x0000000000000001, 0x0000010000000000},
    {0x0000000000000001, 0x0000000100000000},
    {0x0000000000000001, 0x0000000001000000},
    {0x0000000000000001, 0x0000000000010000},
    {0x0000000000000001, 0x0000000000000100},
    {0x0000000000000001, 0x0000000000000001},
    {0x0100000000000001, 0x0000000000000000},
    {0x0001000000000001, 0x0000000000000000},
    {0x0000010000000001, 0x0000000000000000},
    {0x0000000100000001, 0x0000000000000000},
    {0x0000000001000001, 0x0000000000000000},
    {0x0000000000010001, 0x0000000000000000},
    {0x0000000000000101, 0x0000000000000000},
    {0x0000000000000002, 0x0000000000000000},
};

static const unsigned long rtab[16][17] = {
    {
     0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
     0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
     0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
     0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
     0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
     0x0000000000000000, 0x0000000000000000,
    },
    {
     0x0000000000000000, 0x0000000000000001, 0x0000000000000011,
     0x0000000000000111, 0x0000000000001111, 0x0000000000011111,
     0x0000000000111111, 0x0000000001111111, 0x0000000011111111,
     0x0000000111111111, 0x0000001111111111, 0x0000011111111111,
     0x0000111111111111, 0x0001111111111111, 0x0011111111111111,
     0x0111111111111111, 0x1111111111111111,
    },
    {
     0x0000000000000000, 0x0000000000000002, 0x0000000000000022,
     0x0000000000000222, 0x0000000000002222, 0x0000000000022222,
     0x0000000000222222, 0x0000000002222222, 0x0000000022222222,
     0x0000000222222222, 0x0000002222222222, 0x0000022222222222,
     0x0000222222222222, 0x0002222222222222, 0x0022222222222222,
     0x0222222222222222, 0x2222222222222222,
    },
    {
     0x0000000000000000, 0x0000000000000003, 0x0000000000000033,
     0x0000000000000333, 0x0000000000003333, 0x0000000000033333,
     0x0000000000333333, 0x0000000003333333, 0x0000000033333333,
     0x0000000333333333, 0x0000003333333333, 0x0000033333333333,
     0x0000333333333333, 0x0003333333333333, 0x0033333333333333,
     0x0333333333333333, 0x3333333333333333,
    },
    {
     0x0000000000000000, 0x0000000000000004, 0x0000000000000044,
     0x0000000000000444, 0x0000000000004444, 0x0000000000044444,
     0x0000000000444444, 0x0000000004444444, 0x0000000044444444,
     0x0000000444444444, 0x0000004444444444, 0x0000044444444444,
     0x0000444444444444, 0x0004444444444444, 0x0044444444444444,
     0x0444444444444444, 0x4444444444444444,
    },
    {
     0x0000000000000000, 0x0000000000000005, 0x0000000000000055,
     0x0000000000000555, 0x0000000000005555, 0x0000000000055555,
     0x0000000000555555, 0x0000000005555555, 0x0000000055555555,
     0x0000000555555555, 0x0000005555555555, 0x0000055555555555,
     0x0000555555555555, 0x0005555555555555, 0x0055555555555555,
     0x0555555555555555, 0x5555555555555555,
    },
    {
     0x0000000000000000, 0x0000000000000006, 0x0000000000000066,
     0x0000000000000666, 0x0000000000006666, 0x0000000000066666,
     0x0000000000666666, 0x0000000006666666, 0x0000000066666666,
     0x0000000666666666, 0x0000006666666666, 0x0000066666666666,
     0x0000666666666666, 0x0006666666666666, 0x0066666666666666,
     0x0666666666666666, 0x6666666666666666,
    },
    {
     0x0000000000000000, 0x0000000000000007, 0x0000000000000077,
     0x0000000000000777, 0x0000000000007777, 0x0000000000077777,
     0x0000000000777777, 0x0000000007777777, 0x0000000077777777,
     0x0000000777777777, 0x0000007777777777, 0x0000077777777777,
     0x0000777777777777, 0x0007777777777777, 0x0077777777777777,
     0x0777777777777777, 0x7777777777777777,
    },
    {
     0x0000000000000000, 0x0000000000000008, 0x0000000000000088,
     0x0000000000000888, 0x0000000000008888, 0x0000000000088888,
     0x0000000000888888, 0x0000000008888888, 0x0000000088888888,
     0x0000000888888888, 0x0000008888888888, 0x0000088888888888,
     0x0000888888888888, 0x0008888888888888, 0x0088888888888888,
     0x0888888888888888, 0x8888888888888888,
    },
    {
     0x0000000000000000, 0x0000000000000009, 0x0000000000000099,
     0x0000000000000999, 0x0000000000009999, 0x0000000000099999,
     0x0000000000999999, 0x0000000009999999, 0x0000000099999999,
     0x0000000999999999, 0x0000009999999999, 0x0000099999999999,
     0x0000999999999999, 0x0009999999999999, 0x0099999999999999,
     0x0999999999999999, 0x9999999999999999,
    },
    {
     0x0000000000000000, 0x000000000000000a, 0x00000000000000aa,
     0x0000000000000aaa, 0x000000000000aaaa, 0x00000000000aaaaa,
     0x0000000000aaaaaa, 0x000000000aaaaaaa, 0x00000000aaaaaaaa,
     0x0000000aaaaaaaaa, 0x000000aaaaaaaaaa, 0x00000aaaaaaaaaaa,
     0x0000aaaaaaaaaaaa, 0x000aaaaaaaaaaaaa, 0x00aaaaaaaaaaaaaa,
     0x0aaaaaaaaaaaaaaa, 0xaaaaaaaaaaaaaaaa,
    },
    {
     0x0000000000000000, 0x000000000000000b, 0x00000000000000bb,
     0x0000000000000bbb, 0x000000000000bbbb, 0x00000000000bbbbb,
     0x0000000000bbbbbb, 0x000000000bbbbbbb, 0x00000000bbbbbbbb,
     0x0000000bbbbbbbbb, 0x000000bbbbbbbbbb, 0x00000bbbbbbbbbbb,
     0x0000bbbbbbbbbbbb, 0x000bbbbbbbbbbbbb, 0x00bbbbbbbbbbbbbb,
     0x0bbbbbbbbbbbbbbb, 0xbbbbbbbbbbbbbbbb,
    },
    {
     0x0000000000000000, 0x000000000000000c, 0x00000000000000cc,
     0x0000000000000ccc, 0x000000000000cccc, 0x00000000000ccccc,
     0x0000000000cccccc, 0x000000000ccccccc, 0x00000000cccccccc,
     0x0000000ccccccccc, 0x000000cccccccccc, 0x00000ccccccccccc,
     0x0000cccccccccccc, 0x000ccccccccccccc, 0x00cccccccccccccc,
     0x0ccccccccccccccc, 0xcccccccccccccccc,
    },
    {
     0x0000000000000000, 0x000000000000000d, 0x00000000000000dd,
     0x0000000000000ddd, 0x000000000000dddd, 0x00000000000ddddd,
     0x0000000000dddddd, 0x000000000ddddddd, 0x00000000dddddddd,
     0x0000000ddddddddd, 0x000000dddddddddd, 0x00000ddddddddddd,
     0x0000dddddddddddd, 0x000ddddddddddddd, 0x00dddddddddddddd,
     0x0ddddddddddddddd, 0xdddddddddddddddd,
    },
    {
     0x0000000000000000, 0x000000000000000e, 0x00000000000000ee,
     0x0000000000000eee, 0x000000000000eeee, 0x00000000000eeeee,
     0x0000000000eeeeee, 0x000000000eeeeeee, 0x00000000eeeeeeee,
     0x0000000eeeeeeeee, 0x000000eeeeeeeeee, 0x00000eeeeeeeeeee,
     0x0000eeeeeeeeeeee, 0x000eeeeeeeeeeeee, 0x00eeeeeeeeeeeeee,
     0x0eeeeeeeeeeeeeee, 0xeeeeeeeeeeeeeeee,
    },
    {
     0x0000000000000000, 0x000000000000000f, 0x00000000000000ff,
     0x0000000000000fff, 0x000000000000ffff, 0x00000000000fffff,
     0x0000000000ffffff, 0x000000000fffffff, 0x00000000ffffffff,
     0x0000000fffffffff, 0x000000ffffffffff, 0x00000fffffffffff,
     0x0000ffffffffffff, 0x000fffffffffffff, 0x00ffffffffffffff,
     0x0fffffffffffffff, 0xffffffffffffffff,
    },
};

static inline unsigned long nibble_sort_one(unsigned long arg) {
  unsigned long h = 0, l = 0;
  for (int i = 0; i < 8; ++i) {
    l += inc[arg & 255][0];
    h += inc[arg & 255][1];
    arg >>= 8;
  }
  unsigned long r = 0;
  for (int i = 15; i >= 8; --i) {
    int n = l & 255;
    r <<= n * 4;
    r |= rtab[i][n];
    l >>= 8;
  }
  for (int i = 7; i >= 0; --i) {
    int n = h & 255;
    r <<= n * 4;
    r |= rtab[i][n];
    h >>= 8;
  }
  return r;
}

void nibble_sort_rjk9(unsigned long *buffer) {
  for (int i = 0; i < 1024; ++i)
    buffer[i] = nibble_sort_one(buffer[i]);
}
